# 自動アップデート機能 設計書

## 概要

GitHub Actionsを使ったリリース自動化と、アプリ内自動更新機能を実装する。

## 要件

| 項目 | 決定内容 |
|------|----------|
| リリース自動化 | GitHub Actionsでタグpush時にビルド＆Release作成 |
| 更新チェック | アプリ起動時のみ |
| 更新動作 | 通知 → 自動ダウンロード → インストール → 再起動 |
| 配布形式 | ZIP |
| インストール先 | `/Applications/` 固定 |
| バージョン管理 | `app/__init__.py` に一元化 |

## アーキテクチャ

```
┌─────────────────────────────────────────────────────────────┐
│                    GitHub Actions                           │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ タグ v*.*.* をpush                                   │   │
│  │     ↓                                               │   │
│  │ 1. macOS runnerでpy2appビルド                       │   │
│  │ 2. .app を ZIP圧縮                                  │   │
│  │ 3. GitHub Releaseを作成してZIPをアップロード         │   │
│  └─────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│                 GitHub Release                              │
│  - IntegratedWritingGrader-v1.1.0.zip                      │
│  - リリースノート                                           │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│              IntegratedWritingGrader.app                    │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ 起動時                                              │   │
│  │     ↓                                               │   │
│  │ 1. GitHub API で最新リリースをチェック               │   │
│  │ 2. 現在バージョンと比較                             │   │
│  │ 3. 新バージョンあり → ダイアログ表示                │   │
│  │ 4. 「更新する」→ ZIPダウンロード → 解凍 → 置換     │   │
│  │ 5. アプリ再起動                                     │   │
│  └─────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
```

## GitHub Actions ワークフロー

**ファイル**: `.github/workflows/release.yml`

**トリガー**: `v*.*.*` 形式のタグをpushしたとき

**処理フロー**:
1. チェックアウト - リポジトリをクローン
2. Python セットアップ - Python 3.11をインストール
3. 依存関係インストール - `pip install -r requirements.txt py2app`
4. バージョン検証 - タグとapp/__init__.pyのバージョンが一致するか確認
5. ビルド - `python setup.py py2app`
6. ZIP作成 - `IntegratedWritingGrader-v1.1.0.zip` を作成
7. Release作成 - GitHub Releaseを作成してZIPをアップロード

**注意点**:
- macOS runner（`macos-latest`）を使用
- 署名・公証はなし（個人利用前提）

## アプリ内更新機能

**新規ファイル**: `app/utils/updater.py`

**クラス構成**:
```
UpdateChecker
├── check_for_updates()      # GitHub APIで最新バージョン取得
├── compare_versions()       # バージョン比較
├── download_update()        # ZIPダウンロード
├── install_update()         # 解凍＆置換
└── restart_app()            # アプリ再起動
```

**処理詳細**:

1. **バージョンチェック**
   - GitHub API: `GET /repos/sky-wing1/IntegratedWritingGrader/releases/latest`
   - レスポンスから `tag_name` (例: `v1.1.0`) を取得
   - `app/__version__` と比較

2. **ダウンロード**
   - 一時ディレクトリにZIPをダウンロード
   - プログレスバー付きダイアログ表示

3. **インストール**
   - ZIPを解凍
   - `/Applications/IntegratedWritingGrader.app` を新しいものに置換
   - 権限エラー時は `osascript` で管理者権限を要求

4. **再起動**
   - 新しいアプリを `open` コマンドで起動
   - 現在のプロセスを終了

## UI フロー

```
起動 → チェック中（非同期）
         ↓ 新バージョンあり
      ┌─────────────────────────────┐
      │ 新バージョン v1.1.0        │
      │                             │
      │ 更新内容:                   │
      │ - バグ修正                  │
      │ - 新機能追加                │
      │                             │
      │  [後で]  [今すぐ更新]       │
      └─────────────────────────────┘
         ↓ 「今すぐ更新」
      ┌─────────────────────────────┐
      │ ダウンロード中...           │
      │ ████████████░░░░ 75%       │
      └─────────────────────────────┘
         ↓
      インストール → 再起動
```

## バージョン一元化

`app/__init__.py` を唯一の真実に:
```python
__version__ = "1.0.0"
```

`setup.py` で読み込み:
```python
import re
with open("app/__init__.py") as f:
    version = re.search(r'__version__ = "(.+)"', f.read()).group(1)
```

## 作成/変更ファイル一覧

| ファイル | 操作 | 内容 |
|---------|------|------|
| `.github/workflows/release.yml` | 新規 | CI/CDワークフロー |
| `app/utils/updater.py` | 新規 | 更新チェック＆インストール |
| `app/widgets/update_dialog.py` | 新規 | 更新ダイアログUI |
| `app/__init__.py` | 変更なし | バージョン定義（既存） |
| `setup.py` | 変更 | バージョン読み込み方式変更 |
| `app/main.py` | 変更 | 起動時に更新チェック呼び出し |

## リリース手順

```bash
# 1. バージョンを更新
# app/__init__.py の __version__ を "1.1.0" に変更

# 2. コミット
git add app/__init__.py
git commit -m "chore: bump version to 1.1.0"

# 3. タグを作成してpush
git tag v1.1.0
git push origin main --tags

# 4. あとは自動！
# → GitHub Actions がビルド＆Release作成
# → ユーザーのアプリが次回起動時に検知
```
