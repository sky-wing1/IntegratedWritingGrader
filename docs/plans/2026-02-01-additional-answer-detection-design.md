# 追加答案検出機能 設計書

## 概要

PDF読み込み時にQRコードの週番号をチェックし、現在処理中の週と異なる答案を「追加答案」として検出・退避する機能。欠席した生徒が翌週以降に答案を提出するケースに対応。

## ユースケース

1. 第5週の授業で生徒Aが欠席
2. 第6週の授業で生徒Aが「第5週分」の答案を提出
3. 第6週のPDFスキャン時に、第5週分の追加答案を自動検出
4. 追加答案を別フォルダに退避し、後でアプリ内で採点・出力

## 要件

### 検出フェーズ
- PDF読み込み時にQRコードから週番号を識別
- 現在処理中の週と異なる週番号の答案を「追加答案」として検出
- 追加答案は該当週のフォルダに退避（`Week05/additional/`）
- 全ページ処理完了後にまとめて通知

### UIフェーズ
- PDF読込パネルに追加答案セクションを追加
- 追加答案一覧を表示（生徒名・週番号・出席番号）
- チェックボックスで選択可能

### 処理フェーズ
- 追加答案だけで独立して採点・出力が可能
- 既存の週データとは独立して管理（マージしない）
- 結果は `additional_results.json` に保存

## データフロー

```
[PDF読込]
    ↓ QRコード読み取り
    ↓ 週番号チェック
    ├─ 一致 → 通常処理（cropped/に保存）
    └─ 不一致 → 追加答案として検出
                  ↓
              該当週のフォルダに退避
              例: Week05/additional/page_001.png
                  ↓
              処理完了後にまとめて通知
              「3件の追加答案を検出しました」
```

## フォルダ構造

```
~/Documents/IntegratedWritingGrader/2024前期/
├── Week05/
│   ├── cropped/           # 通常の答案画像
│   │   ├── page_001.png
│   │   └── ...
│   ├── additional/        # 追加答案 ★新規
│   │   ├── page_001.png
│   │   ├── metadata.json  # 検出メタデータ
│   │   └── additional_results.json  # 採点結果
│   └── results.json       # 通常の採点結果
├── Week06/
│   └── ...
```

## UI設計

### PDF読込パネル（追加答案セクション）

```
┌─────────────────────────────────────────┐
│ PDF読込パネル                            │
├─────────────────────────────────────────┤
│ [既存のUI...]                           │
│                                         │
│ ─────────────────────────────────────── │
│ 📋 追加答案 (3件)              [展開 ▼] │
│ ┌─────────────────────────────────────┐ │
│ │ □ 第05週 - 山田太郎 (出席番号15)    │ │
│ │ □ 第05週 - 佐藤花子 (出席番号08)    │ │
│ │ □ 第03週 - 鈴木一郎 (出席番号22)    │ │
│ └─────────────────────────────────────┘ │
│ [選択した答案を採点] [すべて採点]        │
└─────────────────────────────────────────┘
```

### 採点・編集パネル（追加答案モード）

```
┌──────────────────────────────────────────────────┐
│ ⚠️ 追加答案モード - 第05週 (2件)    [通常に戻る] │
├──────────────────────────────────────────────────┤
│  [PDFプレビュー]    │    [フィードバックエディタ] │
│                     │                            │
│  ┌───────────────┐  │  得点: [12] / 15点         │
│  │               │  │                            │
│  │   答案画像    │  │  添削答案:                 │
│  │               │  │  ┌──────────────────────┐  │
│  └───────────────┘  │  │ I think that...      │  │
│                     │  └──────────────────────┘  │
│  ページ: 1/2        │                            │
│  山田太郎 (15番)    │  [採点実行] [次へ]         │
└──────────────────────────────────────────────────┘
```

### 出力パネル（追加答案モード）

```
┌─────────────────────────────────────────┐
│ 出力パネル                              │
├─────────────────────────────────────────┤
│ ⚠️ 追加答案モード - 第05週 (2件)        │
│                                         │
│ 出力対象: 追加答案のみ                  │
│ ・山田太郎 (15番) - 12点                │
│ ・佐藤花子 (08番) - 10点                │
│                                         │
│ [PDF出力]  [講評生成]                   │
└─────────────────────────────────────────┘
```

## データ構造

### metadata.json（検出時に作成）

```json
{
  "detected_from_week": 6,
  "detected_at": "2024-06-15T10:30:00",
  "items": [
    {
      "filename": "page_001.png",
      "student_name": "山田太郎",
      "attendance_no": 15,
      "class_name": "A",
      "qr_data": "2024_前期_05_A_15_山田太郎"
    }
  ]
}
```

### additional_results.json（採点後に作成）

```json
{
  "week": 5,
  "term": "前期",
  "detected_at": "2024-06-15",
  "graded_at": "2024-06-15",
  "results": [
    {
      "page": 1,
      "student_name": "山田太郎",
      "attendance_no": 15,
      "total_score": 12,
      "content_score": 10,
      "expression_deduction": 2,
      "content_comment": "...",
      "expression_comment": "...",
      "corrected_text": "...",
      "revision_points": "..."
    }
  ]
}
```

## エッジケース

| ケース | 処理方針 |
|--------|----------|
| QRコードが読めない答案 | 追加答案として検出しない（通常処理に含める） |
| 同じ生徒の重複答案 | 上書きせず、連番で保存（page_001, page_002） |
| 該当週フォルダが存在しない | フォルダを自動作成 |
| 採点途中で中断 | additional_results.json に途中経過を保存 |

## 影響範囲

### 変更が必要なファイル

1. `app/widgets/pdf_loader_panel.py` - 追加答案検出ロジック、UIセクション追加
2. `app/widgets/integrated_grading_panel.py` - 追加答案モード対応
3. `app/widgets/export_panel.py` - 追加答案モード対応
4. `app/utils/qr_parser.py` - 週番号抽出機能追加
5. `app/utils/config.py` - 追加答案パス設定追加
6. `app/main_window.py` - モード切り替え、シグナル接続

### 新規作成ファイル

1. `app/utils/additional_answer_manager.py` - 追加答案管理クラス

## 受け入れ条件

- [ ] PDF読み込み時に異なる週の答案を検出できる
- [ ] 検出した追加答案が該当週の `additional/` フォルダに保存される
- [ ] 処理完了後に追加答案の件数が通知される
- [ ] PDF読込パネルで追加答案一覧が表示される
- [ ] 追加答案を選択して採点・出力ができる
- [ ] 採点結果が `additional_results.json` に保存される
- [ ] 既存の週データに影響しない
